<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset=utf-8>
        <meta name="robots" content="noindex, nofollow">

        <title>Team 1 vs Team 2 | AxS</title>

        <link rel="shortcut icon" href="./resources/images/favicon.ico" type="image/x-icon" />
        <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" />
        <link href="./resources/css/style.css" rel="stylesheet" />
        <!-- <link rel="shortcut icon" type="image/png" href="./resources/favicon.png"/> -->
    </head>

    <body>
        <div class=container>
            <div class=sideBar>
                <div class=sb-header>
                    <div class=sb-header-img></div>
            
                    <div class=sb-header-text>
                        AxS calculator
                        <hr />
                        <a href="#" class="btn btn-sb-menu btn-xs" title="User settings"><i class="far fa-user-circle"></i></a>
                        <a href="./settings.html" class="btn btn-sb-menu btn-xs" title="Settings"><i class="fas fa-cogs"></i></a> 
                    </div>
                </div>
            
                <div class=sb-navigation>
                    <a href="#" class="sb-nav-column"><i class="fas fa-info"></i> Information</a>
                    <a href="./lobbyoverview.html" class="sb-nav-column in"><i class="fas fa-bars"></i> Lobby overview</a>
                    <a href="./createlobby.html" class="sb-nav-column"><i class="far fa-plus-square"></i> Create a lobby</a>
                </div>
            </div>

            <div class=mainContent>
                <div class=matchHeader></div>

                <div class=allMaps></div>
            </div>
        </div>
    </body>

    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
    <script src="./resources/js/jquery-3.3.1.min.js"></script>
    <script src="./resources/js/bootstrap.min.js"></script>
    <script>if (window.module) module = window.module;</script>

    <script>
        const {ipcRenderer, remote} = require('electron');

        function getUrlParamters() {
            let vars = {};

            const parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m, key, value) {
                vars[key] = value;
            });

            return vars;
        }

        $(() => {
            const allUrlParameters = getUrlParamters();
            const lobbyId = allUrlParameters['id'];

            ipcRenderer.send('requestMultiplayerLobby', lobbyId);

            // =================================================
            // This will be called after requestMultiplayerLobby
            ipcRenderer.on('requestedLobby', (event, arg) => {
                // All arg's
                // ---------
                // arg.cache
                // arg.lobby
                // arg.maps

                $('.matchHeader').append(`<h2>${arg.lobby.data.description}</h2>
                                            Multiplayer link: <a href="${arg.lobby.data.multiplayerLink}">${arg.lobby.data.multiplayerLink}</a><br />

                                            <span id="scoreString">${arg.lobby.data.teamOneName} score: <span class=teamLoss>0</span> | <span class=teamWin>6</span> : ${arg.lobby.data.teamTwoName} score</span>
                                            <button id=getMultiplayerData type=button class="btn btn-info float-right">Retrieve multiplayer data</button>
                                            <hr />`);

                for(let map in arg.maps) {
                    const currentMap = arg.maps[map];

                    $('.allMaps').append(`<div class=multiMatch>
                                            <div class=mapPicture style='background-image: url("https://b.ppy.sh/thumb/${arg.cache.beatmaps[currentMap.beatmap_id].beatmapset_id}.jpg");'></div>

                                            <div class=mapContent>
                                                <div class=mapTitle>
                                                    ${arg.cache.beatmaps[currentMap.beatmap_id].name}
                                                </div>

                                                <div class=mapScore>
                                                    <div class=teamLoss>Team red score: 1 607 285</div>
                                                    <div class=teamWin>Team blue score: 2 126 303</div>

                                                    Team blue has won. Team red score: 1 607 285 | Team blue score: 2 126 303 | Score difference: 519 018.
                                                </div>
                                            </div>

                                            <div class=mapButtons>
                                                <button type=button class="btn btn-primary">Copy result</button>
                                                <button type=button class="btn btn-danger">Recalculate score</button>
                                            </div>
                                        </div>`);

                    console.log(currentMap);
                }
                
            });

            
            $('.matchHeader').on('click', '#getMultiplayerData', function() {
                // Request to get new multiplayerdata
                ipcRenderer.send('retrieveMultiplayerData', lobbyId);
            });
        });

        // Open urls in the actual browser and not within the application
        $('body').on('click', '.matchHeader a', (e) => {
            e.preventDefault();
            require("electron").shell.openExternal(e.target.href);
        });
    </script>
</html>