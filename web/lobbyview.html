<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset=utf-8>
        <meta name="robots" content="noindex, nofollow">

        <title>Team 1 vs Team 2 | AxS</title>

        <link rel="shortcut icon" href="./resources/images/favicon.ico" type="image/x-icon" />
        <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" />
        <link href="./resources/css/style.css" rel="stylesheet" />
        <!-- <link rel="shortcut icon" type="image/png" href="./resources/favicon.png"/> -->
    </head>

    <body>
        <div class=container>
            <div class=sideBar>
                <div class=sb-header>
                    <div class=sb-header-img></div>
            
                    <div class=sb-header-text>
                        AxS calculator
                        <hr />
                        <a href="#" class="btn btn-sb-menu btn-xs" title="User settings"><i class="far fa-user-circle"></i></a>
                        <a href="./settings.html" class="btn btn-sb-menu btn-xs" title="Settings"><i class="fas fa-cogs"></i></a> 
                    </div>
                </div>
            
                <div class=sb-navigation>
                    <a href="#" class="sb-nav-column"><i class="fas fa-info"></i> Information</a>
                    <a href="./lobbyoverview.html" class="sb-nav-column in"><i class="fas fa-bars"></i> Lobby overview</a>
                    <a href="./createlobby.html" class="sb-nav-column"><i class="far fa-plus-square"></i> Create a lobby</a>
                </div>
            </div>

            <div class=mainContent>
                <div class=matchHeader></div>

                <div class=allMaps></div>
            </div>
        </div>
    </body>

    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
    <script src="./resources/js/jquery-3.3.1.min.js"></script>
    <script src="./resources/js/bootstrap.min.js"></script>
    <script>if (window.module) module = window.module;</script>

    <script>
        const {ipcRenderer, remote} = require('electron');

        function getUrlParamters() {
            let vars = {};

            const parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m, key, value) {
                vars[key] = value;
            });

            return vars;
        }

        function addDot(nStr, splitter = ' ') {
            nStr += '';
            const x = nStr.split('.');
            let x1 = x[0];
            const x2 = x.length > 1 ? '.' + x[1] : '';
            const rgx = /(\d+)(\d{3})/;

            while (rgx.test(x1)) {
                x1 = x1.replace(rgx, '$1' + splitter + '$2');
            }

            return x1 + x2;
        }

        $(() => {
            const allUrlParameters = getUrlParamters();
            const lobbyId = allUrlParameters['id'];

            ipcRenderer.send('requestMultiplayerLobby', lobbyId);

            // =================================================
            // This will be called after requestMultiplayerLobby
            ipcRenderer.on('requestedLobby', (event, arg) => {
                console.log(arg);
                // All arg's
                // ---------
                // arg.cache
                // arg.lobby
                // arg.maps

                $('.matchHeader').append(`<h2>${arg.lobby.data.description}</h2>
                                            Multiplayer link: <a href="${arg.lobby.data.multiplayerLink}">${arg.lobby.data.multiplayerLink}</a><br />

                                            <span id="scoreString">${arg.lobby.data.teamOneName} score: <span class=teamLoss>0</span> | <span class=teamWin>6</span> : ${arg.lobby.data.teamTwoName} score</span>
                                            <button id=getMultiplayerData type=button class="btn btn-info float-right">Retrieve multiplayer data</button>
                                            <hr />`);

                for(let map in arg.maps) {
                    const currentMap = arg.maps[map];

                    const teamOneColour = (currentMap.team_one_score > currentMap.team_two_score) ? 'teamWin' : 'teamLoss';
                    const teamTwoColour = (currentMap.team_two_score > currentMap.team_one_score) ? 'teamWin' : 'teamLoss';

                    const winMessage = (currentMap.team_one_score > currentMap.team_two_score) ? `<span class=red-text>Team Red</span> has won. <span class=red-text>Team red</span> score: ${addDot(currentMap.team_one_score)} | <span class=blue-text>Team blue</span> score: ${addDot(currentMap.team_two_score)} | Score difference: ${addDot(currentMap.team_one_score - currentMap.team_two_score)}` : `<span class=blue-text>Team blue</span> has won. <span class=red-text>Team red</span> score: ${addDot(currentMap.team_one_score)} | <span class=blue-text>Team blue</span> score: ${addDot(currentMap.team_two_score)} | Score difference: ${addDot(currentMap.team_two_score - currentMap.team_one_score)}`;

                    $('.allMaps').append(`<div class=multiMatch>
                                            <div class=mapPicture style='background-image: url("https://b.ppy.sh/thumb/${arg.cache.beatmaps[currentMap.beatmap_id].beatmapset_id}.jpg");'></div>

                                            <div class=mapContent>
                                                <div class=mapTitle>
                                                    ${arg.cache.beatmaps[currentMap.beatmap_id].name}
                                                </div>

                                                <div class=mapScore>
                                                    <table>
                                                        <tr>
                                                            <td>${arg.cache.users[currentMap[0].user]}</td>
                                                            <td>&emsp;</td>
                                                            <td>${addDot(currentMap[0].score.toFixed())} (${currentMap[0].accuracy}%)</td>
                                                        </tr>

                                                        <tr>
                                                            <td>${arg.cache.users[currentMap[1].user]}</td>
                                                            <td>&emsp;</td>
                                                            <td>${addDot(currentMap[1].score.toFixed())} (${currentMap[1].accuracy}%)</td>
                                                        </tr>

                                                        <tr>
                                                            <td>${arg.cache.users[currentMap[2].user]}</td>
                                                            <td>&emsp;</td>
                                                            <td>${addDot(currentMap[2].score.toFixed())} (${currentMap[2].accuracy}%)</td>
                                                        </tr>

                                                        <tr>
                                                            <td>${arg.cache.users[currentMap[3].user]}</td>
                                                            <td>&emsp;</td>
                                                            <td>${addDot(currentMap[3].score.toFixed())} (${currentMap[3].accuracy}%)</td>
                                                        </tr>

                                                        <tr>
                                                            <td>${arg.cache.users[currentMap[4].user]}</td>
                                                            <td>&emsp;</td>
                                                            <td>${addDot(currentMap[4].score.toFixed())} (${currentMap[4].accuracy}%)</td>
                                                        </tr>

                                                        <tr>
                                                            <td>${arg.cache.users[currentMap[5].user]}</td>
                                                            <td>&emsp;</td>
                                                            <td>${addDot(currentMap[5].score.toFixed())} (${currentMap[5].accuracy}%)</td>
                                                        </tr>
                                                    </table>

                                                    <br />

                                                    <div class=red-text>Team red score: ${addDot(currentMap.team_one_score)}</div>
                                                    <div class=blue-text>Team blue score: ${addDot(currentMap.team_two_score)}</div>

                                                    <br />

                                                    ${winMessage}
                                                </div>
                                            </div>

                                            <div class=mapButtons>
                                                <button type=button class="btn btn-primary">Copy result</button>
                                            </div>
                                        </div>`);
                }
                
            });

            
            $('.matchHeader').on('click', '#getMultiplayerData', function() {
                // Request to get new multiplayerdata
                ipcRenderer.send('retrieveMultiplayerData', lobbyId);
            });
        });

        // Open urls in the actual browser and not within the application
        $('body').on('click', '.matchHeader a', (e) => {
            e.preventDefault();
            require("electron").shell.openExternal(e.target.href);
        });
    </script>
</html>